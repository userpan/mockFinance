# 金融模拟交易所系统 - 产品需求文档 (PRD)

> **项目代号**: MockFinance Exchange  
> **文档版本**: v1.0  
> **创建日期**: 2024年12月  
> **负责人**: 开发团队  

---

## 📋 1. 项目概述

### 1.1 项目定位
**金融模拟交易所系统** - 为金融模拟交易游戏提供核心撮合和交易服务的后端系统

### 1.2 项目范围
- ✅ **包含**: 交易撮合引擎、房间管理、订单管理、数据推送、API服务、用户注册登录系统
- ❌ **不包含**: 玩家客户端界面（独立项目）、AI交易模块（玩家端工具）

### 1.3 系统角色定义
- **交易所系统**: 我们开发的核心系统，提供撮合、数据服务、用户管理等完整后端服务
- **玩家客户端**: 独立的前端项目（类似炒股软件），通过API与交易所通信
- **AI模块**: 玩家端的工具，模拟玩家行为，与交易所无直接关系

### 1.4 核心价值
- **真实交易体验**: 提供接近真实交易所的撮合逻辑和市场机制
- **高性能**: 支持实时撮合和数据推送
- **高扩展性**: 支持从2人到1000+人的房间规模扩展
- **规则灵活**: 通过过滤器架构支持复杂交易规则的持续扩展

---

## 🎯 2. 功能规格

### 2.1 用户管理系统

#### 2.1.1 用户注册登录
- **用户注册**: 支持邮箱/用户名注册
- **用户登录**: 支持密码登录和JWT token认证
- **用户信息**: 用户基本信息管理
- **游戏统计**: 用户历史游戏记录和统计数据

#### 2.1.2 用户认证
- **JWT Token**: 基于JWT的用户认证机制
- **权限管理**: 基础的用户权限控制
- **会话管理**: 用户会话状态管理

### 2.2 房间管理系统

#### 2.2.1 房间创建
- **功能**: 创建新的交易房间
- **参数配置**:
  - 对局时长: 10-30分钟（默认10分钟）
  - 最大玩家数: 2-12人（MVP支持2人）
  - 交易品种: 1个虚拟股票（未来支持多品种）
  - 手续费率: 可配置（默认0.1%）

#### 2.2.2 房间状态管理
- **等待中**: 等待玩家加入
- **准备中**: 玩家已满，准备开始
- **进行中**: 游戏正在进行
- **结算中**: 游戏结束，计算结果
- **已结束**: 房间关闭

#### 2.2.3 玩家加入/退出
- 支持玩家动态加入房间（游戏开始前）
- 支持玩家主动退出
- 游戏开始后不允许新玩家加入

### 2.3 玩家资产系统

#### 2.3.1 初始资产配置
- **随机分配原则**: 每局游戏重新随机分配，不受上局影响
- **公平性保证**: 玩家间总资产差距不超过1倍
- **资产构成**:
  - 现金: 随机金额
  - 股票持仓: 随机数量的虚拟股票
  - 总资产价值: 现金 + 持仓市值

#### 2.3.2 资产计算和排名
- **实时更新**: 根据最新成交价计算持仓市值
- **盈亏计算**: 相对初始资产的盈亏金额和比例
- **排名规则**: **按盈亏比例排名**（因为初始资金不同，不能按最终资产排名）
  - 盈亏比例 = (当前总资产 - 初始总资产) / 初始总资产 × 100%
  - 盈亏比例越高，排名越靠前

### 2.4 撮合交易系统

#### 2.4.1 订单类型（MVP阶段）
- **限价单 (Limit Order)**:
  - 指定价格和数量
  - 只在指定价格或更优价格成交
  - 未成交部分保留在订单簿中

- **市价单 (Market Order)**:
  - 指定数量，以市场最优价格立即成交
  - 优先与订单簿中的订单撮合
  - 如果流动性不足，部分成交

#### 2.4.2 撮合规则
- **价格优先**: 买单价格越高越优先，卖单价格越低越优先
- **时间优先**: 相同价格下，时间越早越优先
- **部分成交**: 支持订单的部分成交
- **即时结算**: 成交后立即更新玩家资产

#### 2.4.3 手续费机制
- **收费方式**: 按成交金额的固定比例收取
- **收费对象**: 交易双方都收取手续费
- **手续费率**: 可配置，默认0.1%
- **扣费时机**: 成交时立即从玩家现金中扣除

### 2.5 市场数据系统

#### 2.5.1 价格发现
- **纯市场驱动**: 价格完全由玩家交易行为决定
- **无人工干预**: 系统不主动调整价格
- **初始价格**: 房间开始时设定基准价格

#### 2.5.2 K线数据
- **时间周期**: 支持1分钟、5分钟K线
- **数据来源**: 基于实际成交记录生成
- **实时更新**: 每次成交后更新当前K线

#### 2.5.3 订单簿数据
- **深度显示**: 显示买卖双方的价格和数量
- **实时更新**: 每次下单、撤单、成交后更新
- **数据精度**: 保留足够精度显示价格和数量

### 2.6 数据推送系统

#### 2.6.1 推送策略（MVP阶段）
- **推送频率**: 每0.5秒检查一次
- **推送条件**: 有交易发生时才推送
- **推送内容**: 最新价格、订单簿变化、成交记录

#### 2.6.2 推送数据类型
- **价格更新**: 最新成交价、涨跌幅
- **订单簿更新**: 买卖深度变化
- **成交记录**: 最新成交的价格、数量、时间
- **玩家资产**: 个人持仓和资产变化
- **排行榜**: 实时盈亏比例排名

---

## 🔄 3. 业务流程

### 3.1 完整游戏流程

```
1. 房间创建
   ├── 设置游戏参数（时长、人数、手续费等）
   └── 房间进入等待状态

2. 玩家加入
   ├── 玩家通过API加入房间
   ├── 系统随机分配初始资产
   └── 等待其他玩家加入

3. 游戏开始
   ├── 达到最小人数（2人）
   ├── 设定初始股票价格
   ├── 开始倒计时
   └── 开放交易功能

4. 交易进行
   ├── 玩家提交买卖订单
   ├── 撮合引擎处理订单
   ├── 执行成交和资产更新
   └── 推送市场数据

5. 游戏结束
   ├── 时间到达或特殊条件触发
   ├── 停止接受新订单
   ├── 计算最终排名
   └── 推送结算结果
```

### 3.2 订单处理流程

```
1. 订单接收
   ├── 验证订单格式和参数
   ├── 检查玩家资金/持仓是否充足
   └── 订单进入撮合队列

2. 撮合处理
   ├── 按价格-时间优先原则排序
   ├── 寻找匹配的对手订单
   ├── 计算成交价格和数量
   └── 执行成交或加入订单簿

3. 成交执行
   ├── 更新买卖双方的资产
   ├── 扣除交易手续费
   ├── 记录成交历史
   └── 推送成交信息

4. 数据更新
   ├── 更新订单簿状态
   ├── 更新最新价格
   ├── 更新K线数据
   └── 推送给所有玩家
```

---

## 📊 4. 数据规格

### 4.1 API接口规格

#### 4.1.1 用户相关接口
```
POST /api/auth/register - 用户注册
POST /api/auth/login - 用户登录
GET /api/auth/profile - 获取用户信息
PUT /api/auth/profile - 更新用户信息
GET /api/auth/stats - 获取用户游戏统计
```

#### 4.1.2 房间相关接口
```
POST /api/rooms - 创建房间
GET /api/rooms/:id - 获取房间信息
POST /api/rooms/:id/join - 加入房间
POST /api/rooms/:id/leave - 离开房间
```

#### 4.1.3 交易相关接口
```
POST /api/orders - 提交订单
GET /api/orders/:id - 查询订单状态
DELETE /api/orders/:id - 撤销订单
GET /api/orderbook/:symbol - 获取订单簿
```

#### 4.1.4 数据查询接口
```
GET /api/player/:id/assets - 获取玩家资产
GET /api/market/:symbol/kline - 获取K线数据
GET /api/market/:symbol/trades - 获取成交记录
GET /api/rooms/:id/ranking - 获取房间排名（按盈亏比例）
```

### 4.2 WebSocket事件规格

#### 4.2.1 推送事件类型
```
market_update - 市场数据更新
order_update - 订单状态更新
trade_executed - 成交通知
asset_update - 资产变化
ranking_update - 排名更新（按盈亏比例）
user_auth - 用户认证状态变化
```

#### 4.2.2 数据格式示例
```json
{
  "event": "market_update",
  "data": {
    "symbol": "STOCK_A",
    "price": 100.50,
    "change": 2.30,
    "change_percent": 2.34,
    "volume": 15000,
    "timestamp": 1703123456789
  }
}
```

### 4.3 数据存储规格

#### 4.3.1 核心数据实体
- **用户数据**: 用户信息、认证数据、游戏统计
- **房间数据**: 房间配置、状态、玩家列表
- **玩家数据**: 资产、持仓、订单历史、盈亏比例
- **订单数据**: 订单详情、状态、成交记录
- **市场数据**: 价格历史、成交记录、K线数据

#### 4.3.2 数据持久化要求
- **房间数据**: 需要持久化，支持房间恢复
- **交易数据**: 必须持久化，用于结算和审计
- **市场数据**: 需要持久化，用于K线生成
- **临时数据**: 订单簿等可以使用内存存储

---

## ⚡ 5. 性能要求

### 5.1 响应时间要求
- **订单提交响应**: < 100ms
- **撮合处理时间**: < 50ms
- **数据推送延迟**: < 200ms
- **API接口响应**: < 500ms

### 5.2 并发处理能力
- **房间并发数**: 支持100+房间同时运行
- **单房间玩家**: 支持2-12人（可扩展到更多）
- **订单处理**: 支持每秒1000+订单处理
- **WebSocket连接**: 支持1000+并发连接

### 5.3 数据一致性要求
- **强一致性**: 玩家资产、订单状态必须强一致
- **最终一致性**: 排行榜、统计数据可以最终一致
- **实时性**: 市场数据推送需要实时性保证

---

## 🔧 6. 质量要求

### 6.1 可用性要求
- **系统可用性**: 99.9%
- **故障恢复**: 支持自动故障恢复
- **数据备份**: 关键数据需要备份

### 6.2 扩展性要求
- **水平扩展**: 支持多实例部署
- **功能扩展**: 支持新订单类型、新交易规则平滑添加
- **数据扩展**: 支持多交易品种、复杂数据结构

### 6.3 安全性要求
- **数据安全**: 交易数据不能丢失或篡改
- **接口安全**: API接口需要适当的验证和限流
- **系统安全**: 防止恶意攻击和异常操作

---

## 🚀 7. 开发优先级

### 7.1 MVP版本功能
- ✅ 用户管理系统（注册登录、JWT认证）
- ✅ 基础房间管理（2人房间）
- ✅ 基础撮合引擎（限价单、市价单）
- ✅ 基础资产管理（随机分配、盈亏比例排名）
- ✅ 基础数据推送（WebSocket）
- ✅ 核心API接口
- ✅ 手续费机制

### 7.2 增强版本功能
- 🔄 复杂订单类型（IOC、FOK）
- 🔄 多交易品种支持
- 🔄 高级撮合规则（滑点、流动性）
- 🔄 数据分析功能
- 🔄 系统监控和管理

### 7.3 完整版本功能
- 🔄 高频交易支持
- 🔄 复杂金融产品（期权、期货）
- 🔄 风险管理系统
- 🔄 大规模并发优化

---

## 📝 8. 验收标准

### 8.1 功能验收标准
- [ ] 用户可以成功注册登录并获得JWT token
- [ ] 2个玩家可以成功创建房间并开始游戏
- [ ] 限价单和市价单可以正确撮合成交
- [ ] 玩家资产可以实时正确更新
- [ ] 盈亏比例可以正确计算并用于排名
- [ ] WebSocket可以正确推送市场数据
- [ ] 手续费可以正确计算和扣除
- [ ] 游戏可以正常结束并显示盈亏比例排名

### 8.2 性能验收标准
- [ ] 订单处理延迟 < 100ms
- [ ] 数据推送延迟 < 200ms
- [ ] 支持10个房间同时运行
- [ ] 支持每个房间2-6个玩家

### 8.3 质量验收标准
- [ ] 系统连续运行24小时无崩溃
- [ ] 数据一致性测试通过
- [ ] 错误处理机制完善
- [ ] 代码覆盖率 > 80%

---

## 🚀 9. 项目进展

> **更新时间**: 2024年12月  
> **当前版本**: v0.1.0-alpha  
> **开发阶段**: 基础架构完成

### 9.1 当前完成状态

#### ✅ 已完成的工作

**基础架构搭建**
- [x] 项目结构设计和搭建
- [x] TypeScript配置和类型系统
- [x] Express.js应用框架集成
- [x] 环境配置管理系统
- [x] 中间件系统（安全、CORS、日志等）
- [x] 路由系统基础框架
- [x] 统一错误处理机制
- [x] 服务器生命周期管理

**代码质量保障**
- [x] 统一的代码风格（箭头函数格式）
- [x] 完整的JSDoc注释文档
- [x] TypeScript严格模式配置
- [x] 开发环境热重载
- [x] 构建系统验证

**技术栈集成**
- [x] Node.js 18+ 运行时环境
- [x] Express.js Web框架
- [x] Helmet安全中间件
- [x] CORS跨域处理
- [x] Morgan请求日志
- [x] 健康检查接口

### 9.2 正在进行的工作

#### 🔄 当前开发任务

**数据库集成** (计划中)
- [ ] MongoDB连接和配置
- [ ] Mongoose ODM集成
- [ ] 数据模型设计和实现
- [ ] 数据库迁移脚本

**用户认证系统** (计划中)
- [ ] JWT认证机制
- [ ] 用户注册和登录API
- [ ] 密码加密和验证
- [ ] 用户权限管理

### 9.3 下一阶段规划

#### 📅 短期目标 (1-2周)

**第一阶段：用户和认证系统**
- [ ] 完成MongoDB集成
- [ ] 实现用户数据模型
- [ ] 开发认证相关API
- [ ] 集成JWT中间件

**第二阶段：房间管理系统**
- [ ] 设计房间状态机
- [ ] 实现房间CRUD操作
- [ ] 开发房间相关API
- [ ] 集成WebSocket通信

#### 📅 中期目标 (1个月)

**第三阶段：游戏核心功能**
- [ ] 实现游戏状态管理
- [ ] 开发基础交易功能
- [ ] 构建撮合引擎
- [ ] 实现排名计算

**第四阶段：实时通信**
- [ ] Socket.io集成
- [ ] 实时数据推送
- [ ] 游戏事件广播
- [ ] 连接管理优化

### 9.4 里程碑计划

| 阶段 | 时间 | 目标 | 完成标准 |
|------|------|------|----------|
| 阶段0 | ✅ 已完成 | 基础架构 | 项目结构+Express框架 |
| 阶段1 | 1周内 | 数据库集成 | MongoDB连接+基础模型 |
| 阶段2 | 2周内 | 用户系统 | 注册登录+JWT认证 |
| 阶段3 | 3周内 | 房间系统 | 房间管理+状态机 |
| 阶段4 | 4周内 | 交易系统 | 下单+撮合+排名 |
| 阶段5 | 6周内 | 实时通信 | WebSocket+数据推送 |
| 阶段6 | 8周内 | MVP完成 | 完整功能+测试 |

---

**文档版本**: v1.1  
**最后更新**: 2024年12月  
**下次更新**: 根据开发进展调整

---

> 💡 **重要提醒**:
> 1. 本文档定义的是交易所系统，包含用户管理，但不包含玩家客户端界面
> 2. 玩家客户端界面是独立项目（类似炒股软件），通过API与交易所通信
> 3. AI模块属于玩家端工具，与交易所系统无直接关系
> 4. 排名系统按盈亏比例计算，不按最终资产金额
> 5. 所有功能都要考虑扩展性，支持未来平滑升级
> 6. MVP版本重点验证核心交易逻辑和用户系统
> 7. **已完成基础架构搭建**，可开始下一阶段开发 