# 金融模拟交易所系统 - 技术架构文档 (TAD)

> **项目代号**: MockFinance Exchange  
> **文档版本**: v2.1  
> **创建日期**: 2024年12月  
> **负责人**: 开发团队  

---

## 🏗️ 1. 整体架构设计

### 1.1 架构理念

本系统采用**事件驱动 + 状态机驱动**的架构模式，结合**分层架构**和**微服务思想**，确保系统的高可扩展性、高可维护性和高性能。

#### 核心设计原则
- **单一职责**：每个模块只负责一个核心业务领域
- **开闭原则**：对扩展开放，对修改封闭
- **依赖倒置**：高层模块不依赖低层模块，都依赖抽象
- **事件驱动**：模块间通过事件进行解耦通信
- **状态机驱动**：复杂业务逻辑通过状态机管理

### 1.2 技术栈策略

#### 后端技术栈
- **运行时环境**: Node.js 18+ (性能优异，生态丰富)
- **Web框架**: Express.js (轻量级，易扩展)
- **实时通信**: Socket.io (WebSocket + 降级方案)
- **状态管理**: XState (状态机库，管理复杂业务状态)
- **数据库**: MongoDB (文档型数据库，适合复杂业务对象)
- **缓存**: Redis (高性能缓存，支持复杂数据结构)
- **认证**: JWT (无状态认证，易于扩展)

#### 技术选型考虑
- **MongoDB vs 关系型数据库**: 交易数据结构复杂且经常变化，文档型数据库更适合
- **Redis vs 内存**: 支持数据持久化和分布式部署
- **XState vs 自建状态管理**: 标准化状态机，减少状态管理bug
- **Socket.io vs 原生WebSocket**: 提供连接管理和降级方案

### 1.3 系统分层架构

```
┌─────────────────────────────────────────┐
│           表现层 (Presentation)          │
│         REST API + WebSocket            │
├─────────────────────────────────────────┤
│           应用层 (Application)           │
│        业务流程编排 + 权限控制            │
├─────────────────────────────────────────┤
│           领域层 (Domain)                │
│      业务逻辑 + 状态机 + 事件处理         │
├─────────────────────────────────────────┤
│         基础设施层 (Infrastructure)       │
│       数据持久化 + 外部服务接口           │
└─────────────────────────────────────────┘
```

#### 分层职责
- **表现层**: 处理HTTP请求、WebSocket连接、数据验证、响应格式化
- **应用层**: 业务流程编排、权限验证、事务管理、跨模块协调
- **领域层**: 核心业务逻辑、状态机管理、业务规则、领域事件
- **基础设施层**: 数据访问、缓存管理、消息队列、第三方服务

---

## 🧩 2. 核心模块设计

### 2.1 用户管理模块 (User Management)

#### 模块职责
- 用户注册、登录、认证
- 用户信息管理和更新
- 游戏统计数据维护
- 权限和角色管理

#### 架构设计
- **认证策略**: JWT无状态认证，支持token刷新
- **密码安全**: bcrypt加密，支持密码策略配置
- **用户状态**: 在线/离线状态管理
- **扩展性**: 支持第三方登录（OAuth）、多因子认证

#### 数据模型
- **用户基础信息**: 用户名、邮箱、密码、个人资料
- **游戏统计**: 总局数、胜率、平均盈亏、最佳表现
- **权限信息**: 角色、权限列表、限制条件

### 2.2 房间管理模块 (Room Management)

#### 模块职责
- 房间生命周期管理
- 玩家加入/退出控制
- 游戏配置和规则管理
- 房间状态同步

#### 架构设计
- **状态机驱动**: 房间状态（等待→准备→进行→结算→结束）
- **配置驱动**: 游戏规则通过配置文件管理，支持动态调整
- **事件驱动**: 房间状态变化通过事件通知相关模块
- **扩展性**: 支持不同游戏模式、自定义规则、房间模板

#### 核心状态机
```
等待玩家 → 准备开始 → 游戏进行 → 结算阶段 → 游戏结束
    ↓         ↓         ↓         ↓         ↓
  玩家管理   初始化     交易执行   排名计算   数据归档
```

### 2.3 交易撮合模块 (Trading Engine)

#### 模块职责
- 订单接收和验证
- 撮合算法执行
- 成交记录生成
- 市场数据更新

#### 架构设计
- **管道模式**: 订单处理采用过滤器管道，支持灵活的业务规则
- **内存优先**: 订单簿使用内存数据结构，保证撮合性能
- **异步处理**: 订单处理和数据持久化异步执行
- **扩展性**: 支持多种订单类型、复杂撮合规则、滑点控制

#### 撮合算法
- **价格优先**: 买单价高优先，卖单价低优先
- **时间优先**: 同价格按时间先后排序
- **部分成交**: 支持订单部分撮合
- **原子性**: 撮合操作保证原子性

### 2.4 资产管理模块 (Asset Management)

#### 模块职责
- 玩家资产计算和更新
- 盈亏比例计算
- 排名系统维护
- 资产变更记录

#### 架构设计
- **实时计算**: 资产价值根据最新价格实时计算
- **快照机制**: 关键时点资产快照，支持历史查询
- **排名算法**: 基于盈亏比例的排名系统
- **扩展性**: 支持多种资产类型、复杂计算规则、风险指标

#### 盈亏计算逻辑
- **基准资产**: 游戏开始时的总资产价值
- **当前资产**: 实时计算的总资产价值
- **盈亏比例**: (当前资产 - 基准资产) / 基准资产 × 100%

### 2.5 市场数据模块 (Market Data)

#### 模块职责
- 价格数据管理
- K线数据生成
- 市场统计计算
- 历史数据归档

#### 架构设计
- **流式处理**: 成交数据实时流式处理生成K线
- **多周期支持**: 同时维护多个时间周期的K线数据
- **数据压缩**: 历史数据采用压缩存储
- **扩展性**: 支持多品种、自定义指标、复杂统计

### 2.6 通信模块 (Communication)

#### 模块职责
- WebSocket连接管理
- 消息推送和广播
- 连接状态监控
- 消息队列管理

#### 架构设计
- **连接池管理**: 高效管理大量WebSocket连接
- **消息分发**: 基于订阅模式的消息分发机制
- **降级处理**: WebSocket连接失败时的降级方案
- **扩展性**: 支持集群部署、消息持久化、推送策略配置

---

## 🔄 3. 状态机架构设计

### 3.1 状态机设计原则

#### 为什么选择状态机
- **复杂状态管理**: 游戏和交易涉及复杂的状态转换
- **状态一致性**: 避免状态不一致导致的业务错误
- **可预测性**: 状态转换路径清晰，易于调试和测试
- **扩展性**: 新增状态和转换条件相对简单

#### 状态机层次结构
```
系统级状态机
├── 房间状态机 (Room State Machine)
├── 用户会话状态机 (User Session State Machine)
├── 交易状态机 (Trading State Machine)
└── 资产状态机 (Asset State Machine)
```

### 3.2 房间状态机设计

#### 状态定义
- **WAITING**: 等待玩家加入
- **PREPARING**: 准备开始游戏
- **PLAYING**: 游戏进行中
- **SETTLING**: 结算阶段
- **FINISHED**: 游戏结束

#### 状态转换条件
- **WAITING → PREPARING**: 达到最小玩家数
- **PREPARING → PLAYING**: 准备倒计时结束
- **PLAYING → SETTLING**: 游戏时间结束或手动结束
- **SETTLING → FINISHED**: 结算完成

#### 扩展性考虑
- 支持暂停/恢复状态
- 支持异常状态处理
- 支持状态持久化和恢复

### 3.3 交易状态机设计

#### 订单状态
- **PENDING**: 待处理
- **PROCESSING**: 处理中
- **PARTIAL_FILLED**: 部分成交
- **FILLED**: 完全成交
- **CANCELLED**: 已取消
- **REJECTED**: 已拒绝

#### 状态转换逻辑
- 订单生命周期管理
- 异常状态处理
- 状态回滚机制

---

## 🔧 4. 数据架构设计

### 4.1 数据存储策略

#### 混合存储架构
- **MongoDB**: 持久化存储，复杂业务对象
- **Redis**: 高速缓存，会话数据，实时数据
- **内存**: 订单簿，实时计算数据

#### 数据分层
```
内存层 (Memory)
├── 订单簿数据
├── 实时价格数据
└── 临时计算结果

缓存层 (Redis)
├── 用户会话数据
├── 房间状态数据
└── 实时排名数据

持久层 (MongoDB)
├── 用户基础数据
├── 历史交易数据
└── 游戏记录数据
```

### 4.2 数据一致性策略

#### 一致性级别
- **强一致性**: 用户资产、订单状态、成交记录
- **最终一致性**: 排名数据、统计数据、历史数据
- **弱一致性**: 实时推送数据、临时状态

#### 数据同步机制
- **事件驱动同步**: 关键数据变更通过事件同步
- **定时同步**: 非关键数据定时批量同步
- **冲突解决**: 数据冲突的检测和解决机制

### 4.3 数据模型设计

#### 设计原则
- **聚合根**: 每个业务实体作为聚合根
- **值对象**: 不可变的值对象设计
- **领域事件**: 重要业务变更产生领域事件
- **版本控制**: 数据模型支持版本演进

#### 核心聚合
- **用户聚合**: 用户信息 + 游戏统计
- **房间聚合**: 房间配置 + 玩家列表 + 游戏状态
- **订单聚合**: 订单信息 + 成交记录
- **资产聚合**: 资产信息 + 变更历史

---

## 🚀 5. 扩展性架构设计

### 5.1 水平扩展设计

#### 无状态设计
- **API层无状态**: 所有状态存储在数据库或缓存中
- **负载均衡**: 支持多实例部署和负载均衡
- **会话管理**: 基于JWT的无状态会话管理

#### 数据库扩展
- **读写分离**: 支持MongoDB读写分离
- **分片策略**: 按房间或用户分片
- **缓存策略**: 多级缓存减少数据库压力

### 5.2 功能扩展设计

#### 插件化架构
- **过滤器插件**: 撮合规则可插拔
- **策略插件**: 排名算法可配置
- **通知插件**: 消息推送方式可扩展

#### 配置驱动
- **业务规则配置化**: 游戏规则通过配置文件管理
- **参数可调**: 关键参数支持动态调整
- **A/B测试**: 支持不同配置的A/B测试

### 5.3 订单类型扩展

#### 扩展机制
- **订单类型注册**: 新订单类型通过注册机制添加
- **处理器模式**: 每种订单类型有独立的处理器
- **验证链**: 订单验证规则可配置和扩展

#### 未来订单类型
- **IOC订单**: 立即成交或取消
- **FOK订单**: 全部成交或取消
- **止损订单**: 条件触发订单
- **算法订单**: 智能拆分订单

### 5.4 多品种交易扩展

#### 架构支持
- **品种抽象**: 交易品种抽象化设计
- **独立订单簿**: 每个品种独立的订单簿
- **统一接口**: 统一的交易接口支持多品种

#### 扩展路径
- **股票 → 期货**: 支持保证金交易
- **现货 → 衍生品**: 支持期权等复杂产品
- **单一 → 组合**: 支持投资组合交易

---

## 🔍 6. 性能架构设计

### 6.1 性能目标

#### 响应时间要求
- **订单处理**: < 50ms
- **API响应**: < 200ms
- **WebSocket推送**: < 100ms
- **页面加载**: < 1s

#### 吞吐量要求
- **并发用户**: 1000+ 在线用户
- **订单处理**: 10000+ 订单/秒
- **消息推送**: 50000+ 消息/秒

### 6.2 性能优化策略

#### 计算优化
- **内存计算**: 关键计算在内存中进行
- **异步处理**: 非关键路径异步处理
- **批量操作**: 数据库操作尽量批量化
- **缓存策略**: 多级缓存减少重复计算

#### 网络优化
- **连接复用**: WebSocket连接复用
- **数据压缩**: 传输数据压缩
- **CDN加速**: 静态资源CDN分发
- **协议优化**: 使用高效的序列化协议

### 6.3 监控和调优

#### 性能监控
- **实时监控**: 关键指标实时监控
- **性能分析**: 定期性能分析和调优
- **瓶颈识别**: 自动识别性能瓶颈
- **告警机制**: 性能异常自动告警

---

## 🛡️ 7. 安全架构设计

### 7.1 认证和授权

#### 多层认证
- **用户认证**: JWT token认证
- **API认证**: API密钥认证
- **会话管理**: 安全的会话管理机制

#### 权限控制
- **RBAC模型**: 基于角色的权限控制
- **资源权限**: 细粒度的资源访问控制
- **动态权限**: 支持动态权限调整

### 7.2 数据安全

#### 数据保护
- **敏感数据加密**: 密码等敏感数据加密存储
- **传输加密**: HTTPS/WSS加密传输
- **数据脱敏**: 日志中敏感数据脱敏

#### 交易安全
- **订单验证**: 多层订单验证机制
- **资金安全**: 资金变动的安全控制
- **异常检测**: 异常交易行为检测

---

## 🔧 8. 运维架构设计

### 8.1 部署架构

#### 容器化部署
- **Docker容器**: 应用容器化部署
- **编排工具**: Kubernetes或Docker Compose
- **环境隔离**: 开发、测试、生产环境隔离

#### 服务治理
- **服务发现**: 自动服务发现和注册
- **负载均衡**: 智能负载均衡
- **故障转移**: 自动故障检测和转移

### 8.2 监控和日志

#### 监控体系
- **系统监控**: CPU、内存、网络等系统指标
- **应用监控**: 业务指标、性能指标
- **用户监控**: 用户行为和体验监控

#### 日志管理
- **结构化日志**: 统一的日志格式
- **日志聚合**: 集中式日志收集和分析
- **日志分析**: 实时日志分析和告警

---

## 📋 9. 当前实现状态

> **更新时间**: 2024年12月  
> **实现阶段**: 基础架构搭建完成

### 9.1 已完成的基础架构

#### 项目结构搭建 ✅
```
src/
├── app.ts              # Express应用主入口
├── server.ts           # 服务器启动文件
├── config/             # 配置管理模块
│   ├── index.ts        # 配置入口
│   └── environment.ts  # 环境变量处理
├── common/             # 共享工具和类型
│   ├── types/          # TypeScript类型定义
│   └── utils/          # 工具函数库
├── middleware/         # Express中间件
├── routes/             # 路由模块
├── error/              # 错误处理
└── features/           # 业务模块（待实现）
```

#### 配置系统实现 ✅
- **环境变量管理**: 完整的类型安全环境变量处理
- **多环境支持**: dev/prod环境配置分离
- **配置验证**: 启动时配置有效性检查
- **类型定义**: 完整的TypeScript类型支持

#### 基础服务架构 ✅
- **Express应用**: 标准的Express.js应用框架
- **中间件系统**: 安全、CORS、日志、请求解析
- **路由系统**: 模块化路由注册机制
- **错误处理**: 统一的错误处理和404处理
- **优雅关闭**: 完整的服务器生命周期管理

#### 开发体验优化 ✅
- **TypeScript配置**: 严格模式TypeScript配置
- **代码风格**: 统一的代码风格和注释规范
- **热重载**: 开发环境热重载支持
- **路径别名**: 简化的导入路径配置

### 9.2 代码质量标准

#### 函数定义标准 ✅
- 所有导出函数使用箭头函数格式：`export const functionName = () => {}`
- 统一的函数签名和返回类型注解
- 清晰的参数验证和错误处理

#### 注释文档标准 ✅
- 每个文件都有完整的文件头注释
- 每个函数都有JSDoc格式的文档注释
- 关键逻辑都有内联注释说明
- VS Code hover提示功能完善

#### 错误处理标准 ✅
- 统一的错误处理中间件
- 开发/生产环境错误信息差异化
- 完整的异常捕获机制
- 优雅的错误响应格式

### 9.3 技术栈实现

#### 核心技术栈 ✅
- **Node.js 18+**: 运行时环境
- **Express.js**: Web应用框架
- **TypeScript**: 静态类型检查
- **配置管理**: 环境变量和配置系统

#### 中间件集成 ✅
- **Helmet**: 安全头部设置
- **CORS**: 跨域请求处理  
- **Morgan**: HTTP请求日志
- **Body Parser**: 请求体解析

### 9.4 下一步开发计划

#### 即将实现的模块
1. **数据库连接** - MongoDB连接和基础模型
2. **用户认证系统** - JWT认证和用户管理
3. **房间管理模块** - 游戏房间的创建和管理
4. **WebSocket通信** - 实时数据推送机制
5. **交易撮合引擎** - 核心业务逻辑实现

#### 技术集成计划
- **MongoDB + Mongoose**: 数据持久化
- **Socket.io**: WebSocket实时通信
- **Redis**: 缓存和会话管理
- **XState**: 状态机管理
- **JWT**: 用户认证

### 9.5 架构验证

#### 构建验证 ✅
- TypeScript编译无错误
- 代码风格一致性检查通过
- 所有模块正确导入导出

#### 功能验证 ✅
- Express应用正常启动
- 健康检查接口正常响应
- 中间件链正确执行
- 错误处理机制工作正常

---

**文档版本**: v2.1  
**最后更新**: 2024年12月  
**下次更新**: 根据架构演进调整

---

> 💡 **架构设计要点**:
> 1. **事件驱动 + 状态机驱动**的核心架构模式
> 2. **分层架构**确保职责清晰和可维护性
> 3. **插件化设计**支持功能的灵活扩展
> 4. **混合存储策略**平衡性能和一致性
> 5. **水平扩展**支持系统规模的增长
> 6. **性能优先**的技术选型和架构决策
> 7. **安全第一**的全方位安全架构设计
> 8. **代码质量**统一的开发标准和文档规范 