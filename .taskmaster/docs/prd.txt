# 金融模拟交易所系统 - 产品需求文档

## 项目概述
金融模拟交易所系统 - 为金融模拟交易游戏提供核心撮合和交易服务的后端系统

### 项目范围
- 包含: 交易撮合引擎、房间管理、订单管理、数据推送、API服务、用户注册登录系统
- 不包含: 玩家客户端界面（独立项目）、AI交易模块（玩家端工具）

### 核心价值
- 真实交易体验: 提供接近真实交易所的撮合逻辑和市场机制
- 高性能: 支持实时撮合和数据推送
- 高扩展性: 支持从2人到1000+人的房间规模扩展
- 规则灵活: 通过过滤器架构支持复杂交易规则的持续扩展

## 功能规格

### 用户管理系统
- 用户注册: 支持邮箱/用户名注册
- 用户登录: 支持密码登录和JWT token认证
- 用户信息: 用户基本信息管理
- 游戏统计: 用户历史游戏记录和统计数据
- JWT Token: 基于JWT的用户认证机制
- 权限管理: 基础的用户权限控制
- 会话管理: 用户会话状态管理

### 房间管理系统
- 房间创建: 创建新的交易房间，支持参数配置
  - 对局时长: 10-30分钟（默认10分钟）
  - 最大玩家数: 2-12人（MVP支持2人）
  - 交易品种: 1个虚拟股票（未来支持多品种）
  - 手续费率: 可配置（默认0.1%）
- 房间状态管理: 等待中、准备中、进行中、结算中、已结束
- 玩家加入/退出: 支持玩家动态加入房间（游戏开始前）

### 玩家资产系统
- 初始资产配置: 每局游戏重新随机分配，玩家间总资产差距不超过1倍
- 资产构成: 现金 + 股票持仓 = 总资产价值
- 资产计算和排名: 按盈亏比例排名（因为初始资金不同）
  - 盈亏比例 = (当前总资产 - 初始总资产) / 初始总资产 × 100%

### 撮合交易系统
- 订单类型（MVP阶段）:
  - 限价单: 指定价格和数量，只在指定价格或更优价格成交
  - 市价单: 指定数量，以市场最优价格立即成交
- 撮合规则: 价格优先、时间优先、部分成交、即时结算
- 手续费机制: 按成交金额的固定比例收取，默认0.1%

### 市场数据系统
- 价格发现: 纯市场驱动，价格完全由玩家交易行为决定
- K线数据: 支持1分钟、5分钟K线，基于实际成交记录生成
- 订单簿数据: 显示买卖双方的价格和数量，实时更新

### 数据推送系统
- 推送策略: 每0.5秒检查一次，有交易发生时才推送
- 推送数据类型: 价格更新、订单簿更新、成交记录、玩家资产、排行榜

## 技术要求

### 架构要求
- 使用XState状态机管理所有业务流程
- 五层分离架构：API层、业务层、撮合层、数据层、推送层
- 过滤器/规则引擎支持扩展
- 支持MongoDB数据存储和Redis缓存

### 性能要求
- 订单提交响应: < 100ms
- 撮合处理时间: < 50ms
- 数据推送延迟: < 200ms
- API接口响应: < 500ms
- 支持100+房间同时运行
- 支持每秒1000+订单处理

### API接口规格
- 用户相关: 注册、登录、用户信息、游戏统计
- 房间相关: 创建房间、获取房间信息、加入/离开房间
- 交易相关: 提交订单、查询订单状态、撤销订单、获取订单簿
- 数据查询: 获取玩家资产、K线数据、成交记录、房间排名

### WebSocket事件
- market_update: 市场数据更新
- order_update: 订单状态更新
- trade_executed: 成交通知
- asset_update: 资产变化
- ranking_update: 排名更新（按盈亏比例）
- user_auth: 用户认证状态变化

## MVP版本功能
- 用户管理系统（注册登录、JWT认证）
- 基础房间管理（2人房间）
- 基础撮合引擎（限价单、市价单）
- 基础资产管理（随机分配、盈亏比例排名）
- 基础数据推送（WebSocket）
- 核心API接口
- 手续费机制

## 验收标准
- 用户可以成功注册登录并获得JWT token
- 2个玩家可以成功创建房间并开始游戏
- 限价单和市价单可以正确撮合成交
- 玩家资产可以实时正确更新
- 盈亏比例可以正确计算并用于排名
- WebSocket可以正确推送市场数据
- 手续费可以正确计算和扣除
- 游戏可以正常结束并显示盈亏比例排名
- 订单处理延迟 < 100ms
- 数据推送延迟 < 200ms
- 支持10个房间同时运行
- 系统连续运行24小时无崩溃 